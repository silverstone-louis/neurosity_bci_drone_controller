<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dual Model BCI Drone Control</title>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <style>
        /* General Reset */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        /* Body Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header Styling */
        header {
            background: #1a1a1a;
            padding: 1rem 2rem;
            border-bottom: 2px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-size: 1.8rem;
            font-weight: 300;
            letter-spacing: 0.05em;
        }
        
        .header-info {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
            color: #888;
        }
        
        /* Main Container */
        .container {
            flex: 1;
            padding: 2rem;
            max-width: 1800px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Grid Layouts */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .video-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        /* Panel Styling */
        .panel {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .panel h2 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #00ff41;
            font-weight: 400;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .model-indicator {
            font-size: 0.8rem;
            padding: 0.2rem 0.6rem;
            background: #333;
            border-radius: 4px;
            color: #aaa;
        }
        
        /* Video Display */
        .video-panel {
            background: #0f0f0f;
            border: 2px solid #333;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            background: #000;
        }
        
        #videoDisplay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
        }
        
        .video-status {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
        }
        
        .video-stat {
            background: rgba(0,0,0,0.5);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .video-stat.connected {
            border: 1px solid #00ff41;
        }
        
        .video-stat.disconnected {
            border: 1px solid #ff4141;
        }
        
        .no-video-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
        }
        
        /* Model Specific Border Colors */
        .model-4class { border-left: 3px solid #00a8ff; }
        .model-8class { border-left: 3px solid #ff6b00; }
        
        /* Prediction Bars */
        .predictions {
            margin-top: 1rem;
        }
        
        .prediction-bar {
            margin-bottom: 1rem;
        }
        
        .prediction-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }
        
        .prediction-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .threshold-indicator {
            font-size: 0.7rem;
            color: #666;
        }
        
        .prediction-track {
            height: 24px;
            background: #0f0f0f;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 1px solid #2a2a2a;
        }
        
        .prediction-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff41, #00cc33);
            transition: width 0.3s ease;
            position: relative;
        }
        
        .prediction-fill.active {
            background: linear-gradient(90deg, #ff6b00, #ff4500);
            box-shadow: 0 0 10px rgba(255, 107, 0, 0.5);
        }
        
        .prediction-fill.below-threshold {
            background: linear-gradient(90deg, #444, #666);
        }
        
        .threshold-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ff0;
            opacity: 0.5;
            pointer-events: none;
        }
        
        /* Status Grid */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        .status-item {
            background: #0f0f0f;
            padding: 0.8rem;
            border-radius: 4px;
            border: 1px solid #2a2a2a;
        }
        
        .status-label {
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-value {
            font-size: 1.1rem;
            margin-top: 0.2rem;
            font-weight: 500;
        }
        
        .status-value.connected { color: #00ff41; }
        .status-value.disconnected { color: #ff4141; }
        .status-value.warning { color: #ffaa00; }
        
        /* Command Flow Visualizer */
        .command-flow {
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 1rem;
            background: #0f0f0f;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .flow-item {
            text-align: center;
            padding: 0.5rem;
        }
        
        .flow-arrow {
            color: #666;
            font-size: 1.5rem;
        }
        
        .active-command {
            padding: 0.5rem 1rem;
            background: #ff6b00;
            color: #000;
            border-radius: 4px;
            font-weight: 600;
        }
        
        /* Drone Controls */
        .drone-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .btn {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #fff;
            padding: 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .btn:hover:not(:disabled) {
            background: #3a3a3a;
            border-color: #666;
        }
        
        .btn:active:not(:disabled) {
            transform: scale(0.98);
        }
        
        .btn.primary {
            background: #00ff41;
            color: #000;
            border-color: #00ff41;
            font-weight: 600;
        }
        
        .btn.danger {
            background: #ff4141;
            border-color: #ff4141;
            font-weight: 600;
        }
        
        .btn.warning {
            background: #ff6b00;
            color: #000;
            border-color: #ff6b00;
            font-weight: 600;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Command History */
        .command-history {
            max-height: 250px;
            overflow-y: auto;
            background: #0f0f0f;
            border-radius: 4px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            border: 1px solid #2a2a2a;
        }
        
        .history-entry {
            padding: 0.3rem 0;
            border-bottom: 1px solid #1a1a1a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-entry:last-child {
            border-bottom: none;
        }
        
        .history-time {
            color: #666;
            font-size: 0.8rem;
        }
        
        .history-command {
            color: #00ff41;
            font-weight: 600;
        }
        
        .history-source {
            color: #888;
            font-size: 0.8rem;
        }
        
        /* Connection Indicator Dot */
        .connection-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        
        .connection-indicator.connected {
            background: #00ff41;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }
        
        .connection-indicator.disconnected {
            background: #ff4141;
        }
        
        /* Bottom Grid Layout */
        .bottom-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }
        
        /* Debug Panel */
        .debug-panel {
            background: #0f0f0f;
            border: 2px solid #ff6b00;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .debug-info {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #ff6b00;
        }
        
        /* State Machine Visualization */
        .state-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .state-node {
            padding: 0.5rem 1rem;
            border: 2px solid #444;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .state-node.active {
            border-color: #00ff41;
            background: rgba(0, 255, 65, 0.1);
            color: #00ff41;
        }
        
        .state-transition {
            color: #666;
        }
        
        /* Manual Override Toggle */
        .override-toggle {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            background: #1a1a1a;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #444;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: #ff6b00;
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
        }
        
        /* Responsive Adjustments */
        @media (max-width: 1400px) {
            .video-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 1200px) {
            .main-grid, .bottom-grid {
                grid-template-columns: 1fr;
            }
            
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .drone-controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>
            Dual Model BCI Drone Control
            <span id="mainConnectionIndicator" class="connection-indicator disconnected"></span>
        </h1>
        <div class="header-info">
            <span>4-Class: Rotation/Fwd</span>
            <span>|</span>
            <span>8-Class: Actions</span>
            <span>|</span>
            <span id="videoStatusText">Video: Disconnected</span>
        </div>
    </header>
    
    <div class="container">
        <!-- Video Feed Section -->
        <div class="video-grid">
            <div class="video-panel">
                <div class="video-container">
                    <img id="videoDisplay" style="display: none;" />
                    <div id="noVideoMessage" class="no-video-message">
                        <h3>No Video Signal</h3>
                        <p>Waiting for drone video stream...</p>
                    </div>
                    <div class="video-overlay">
                        <div class="video-status">
                            <div id="videoFPS" class="video-stat">
                                FPS: <span id="videoFPSValue">0</span>
                            </div>
                            <div id="videoFrames" class="video-stat">
                                Frames: <span id="videoFrameCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h2>Video Stats</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">Stream Status</div>
                        <div id="videoStreamStatus" class="status-value disconnected">Disconnected</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Current FPS</div>
                        <div id="videoCurrentFPS" class="status-value">0</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Latency</div>
                        <div id="videoLatency" class="status-value">0ms</div>
                    </div>
                </div>
                
                <div style="margin-top: 1rem;">
                    <button class="btn" onclick="saveSnapshot()">
                        üì∏ Save Snapshot
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Debug Panel -->
        <div class="debug-panel">
            <h3 style="color: #ff6b00; margin-bottom: 0.5rem;">System Debug Info</h3>
            <div class="debug-info">
                <div>Drone State: <span id="debugDroneState">Unknown</span></div>
                <div>Heading Control: <span id="debugHeadingControl">Inactive</span></div>
                <div>Manual Override: <span id="debugManualOverride">OFF</span></div>
                <div>Last State Change: <span id="debugLastStateChange">None</span></div>
                <div>Video Stream: <span id="debugVideoStream">Inactive</span></div>
            </div>
        </div>
        
        <!-- Main prediction panels -->
        <div class="main-grid">
            <!-- 4-Class Model Panel -->
            <div class="panel model-4class">
                <h2>
                    4-Class Control Model
                    <span class="model-indicator">4-Class</span>
                </h2>
                <div class="predictions">
                    <div class="prediction-bar">
                        <div class="prediction-label">
                            <span>Rest</span>
                            <div class="prediction-info">
                                <span id="4class_restProb">0.00</span>
                                <span class="threshold-indicator">(‚â•0.50)</span>
                            </div>
                        </div>
                        <div class="prediction-track">
                            <div id="4class_restBar" class="prediction-fill" style="width: 0%"></div>
                            <div class="threshold-line" style="left: 50%"></div>
                        </div>
                    </div>
                    <div class="prediction-bar">
                        <div class="prediction-label">
                            <span>Left Fist ‚Üí Rotate Left</span>
                            <div class="prediction-info">
                                <span id="4class_leftProb">0.00</span>
                                <span class="threshold-indicator">(‚â•0.30)</span>
                            </div>
                        </div>
                        <div class="prediction-track">
                            <div id="4class_leftBar" class="prediction-fill" style="width: 0%"></div>
                            <div class="threshold-line" style="left: 30%"></div>
                        </div>
                    </div>
                    <div class="prediction-bar">
                        <div class="prediction-label">
                            <span>Right Fist ‚Üí Rotate Right</span>
                            <div class="prediction-info">
                                <span id="4class_rightProb">0.00</span>
                                <span class="threshold-indicator">(‚â•0.30)</span>
                            </div>
                        </div>
                        <div class="prediction-track">
                            <div id="4class_rightBar" class="prediction-fill" style="width: 0%"></div>
                            <div class="threshold-line" style="left: 30%"></div>
                        </div>
                    </div>
                    <div class="prediction-bar">
                        <div class="prediction-label">
                            <span>Both Fists ‚Üí Forward</span>
                            <div class="prediction-info">
                                <span id="4class_bothProb">0.00</span>
                                <span class="threshold-indicator">(‚â•0.30)</span>
                            </div>
                        </div>
                        <div class="prediction-track">
                            <div id="4class_bothBar" class="prediction-fill" style="width: 0%"></div>
                            <div class="threshold-line" style="left: 30%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Heading Control Status -->
                <div style="margin-top: 1rem; padding: 0.5rem; background: #0f0f0f; border-radius: 4px;">
                    <div style="font-size: 0.9rem; color: #888;">Heading Control</div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                        <span>Control Value: <span id="headingControlValue" style="color: #00ff41;">0.00</span></span>
                        <span>Dead Zone: <span id="headingDeadZone" style="color: #666;">NO</span></span>
                    </div>
                </div>
            </div>
            
            <!-- 8-Class Model Panel -->
            <div class="panel model-8class">
                <h2>
                    Action Control Model
                    <span class="model-indicator">8-Class</span>
                </h2>
                <div class="predictions">
                    <div class="prediction-bar">
                        <div class="prediction-label">
                            <span>Push ‚Üí Takeoff/Land</span>
                            <div class="prediction-info">
                                <span id="8class_pushProb">0.00</span>
                                <span class="threshold-indicator">(‚â•0.60)</span>
                            </div>
                        </div>
                        <div class="prediction-track">
                            <div id="8class_pushBar" class="prediction-fill" style="width: 0%"></div>
                            <div class="threshold-line" style="left: 60%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- State Machine Visualization -->
                <div class="state-diagram">
                    <div id="stateGrounded" class="state-node">Grounded</div>
                    <div class="state-transition">‚Üí</div>
                    <div id="stateTakingOff" class="state-node">Taking Off</div>
                    <div class="state-transition">‚Üí</div>
                    <div id="stateFlying" class="state-node">Flying</div>
                    <div class="state-transition">‚Üí</div>
                    <div id="stateLanding" class="state-node">Landing</div>
                </div>
            </div>
        </div>
        
        <!-- Status and Controls -->
        <div class="bottom-grid">
            <div class="panel">
                <h2>System Status</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">Neurosity</div>
                        <div id="neurosityStatus" class="status-value disconnected">Disconnected</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Models</div>
                        <div id="modelStatus" class="status-value disconnected">Not Loaded</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Drone State</div>
                        <div id="droneState" class="status-value">Grounded</div>
                    </div>
                </div>
                
                <!-- Manual Override Toggle -->
                <div class="override-toggle">
                    <span>Manual Override (Test Rotation Without Flying):</span>
                    <div id="overrideToggle" class="toggle-switch" onclick="toggleManualOverride()">
                        <div class="toggle-slider"></div>
                    </div>
                    <span id="overrideStatus" style="color: #666;">OFF</span>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; font-size: 1.1rem; color: #00ff41;">
                    Manual Controls
                </h3>
                <div class="drone-controls">
                    <button id="takeoffBtn" class="btn primary" onclick="sendManualCommand('takeoff')">
                        Takeoff
                    </button>
                    <button id="landBtn" class="btn danger" onclick="sendManualCommand('land')">
                        Land
                    </button>
                    <button class="btn danger" onclick="sendManualCommand('emergency')">
                        Emergency
                    </button>
                    <button class="btn" onclick="sendManualCommand('rotate_left')">
                        ‚Üê Left
                    </button>
                    <button class="btn" onclick="sendManualCommand('status')">
                        Status
                    </button>
                    <button class="btn" onclick="sendManualCommand('rotate_right')">
                        Right ‚Üí
                    </button>
                    <button class="btn warning" onclick="simulateCompletion('takeoff')">
                        Simulate Takeoff Done
                    </button>
                    <button class="btn warning" onclick="simulateCompletion('land')">
                        Simulate Land Done
                    </button>
                    <button class="btn" onclick="resetHeadingController()">
                        Reset Heading
                    </button>
                </div>
            </div>
            
            <div class="panel">
                <h2>Command History</h2>
                <div id="commandHistory" class="command-history">
                    <div class="history-entry">
                        <span>Waiting for commands...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // WebSocket connection
        let socket = null;
        let droneState = 'grounded';
        let manualOverride = false;
        
        // Video state
        let videoActive = false;
        let lastVideoFrame = 0;
        let videoFPSCounter = 0;
        let videoFPSTimer = null;
        
        // DOM elements
        const elements = {
            mainIndicator: document.getElementById('mainConnectionIndicator'),
            neurosityStatus: document.getElementById('neurosityStatus'),
            modelStatus: document.getElementById('modelStatus'),
            droneState: document.getElementById('droneState'),
            commandHistory: document.getElementById('commandHistory'),
            takeoffBtn: document.getElementById('takeoffBtn'),
            landBtn: document.getElementById('landBtn'),
            
            // Video elements
            videoDisplay: document.getElementById('videoDisplay'),
            noVideoMessage: document.getElementById('noVideoMessage'),
            videoStatusText: document.getElementById('videoStatusText'),
            videoStreamStatus: document.getElementById('videoStreamStatus'),
            videoFPSValue: document.getElementById('videoFPSValue'),
            videoCurrentFPS: document.getElementById('videoCurrentFPS'),
            videoFrameCount: document.getElementById('videoFrameCount'),
            videoLatency: document.getElementById('videoLatency'),
            debugVideoStream: document.getElementById('debugVideoStream'),
            
            // Debug elements
            debugDroneState: document.getElementById('debugDroneState'),
            debugHeadingControl: document.getElementById('debugHeadingControl'),
            debugManualOverride: document.getElementById('debugManualOverride'),
            debugLastStateChange: document.getElementById('debugLastStateChange'),
            
            // State nodes
            stateGrounded: document.getElementById('stateGrounded'),
            stateTakingOff: document.getElementById('stateTakingOff'),
            stateFlying: document.getElementById('stateFlying'),
            stateLanding: document.getElementById('stateLanding'),
            
            // Heading control
            headingControlValue: document.getElementById('headingControlValue'),
            headingDeadZone: document.getElementById('headingDeadZone'),
            
            // Override
            overrideToggle: document.getElementById('overrideToggle'),
            overrideStatus: document.getElementById('overrideStatus'),
            
            // 4-class elements
            '4class_restProb': document.getElementById('4class_restProb'),
            '4class_leftProb': document.getElementById('4class_leftProb'),
            '4class_rightProb': document.getElementById('4class_rightProb'),
            '4class_bothProb': document.getElementById('4class_bothProb'),
            '4class_restBar': document.getElementById('4class_restBar'),
            '4class_leftBar': document.getElementById('4class_leftBar'),
            '4class_rightBar': document.getElementById('4class_rightBar'),
            '4class_bothBar': document.getElementById('4class_bothBar'),
            
            // 8-class elements
            '8class_pushProb': document.getElementById('8class_pushProb'),
            '8class_pushBar': document.getElementById('8class_pushBar')
        };
        
        // Updated thresholds from config
        const thresholds = {
            'Rest': 0.50,
            'Left_Fist': 0.30,
            'Right_Fist': 0.30,
            'Both_Fists': 0.30,
            'Push': 0.60,
        };
        
        // Connect to WebSocket
        function connectWebSocket() {
            socket = io(window.location.origin);
            
            socket.on('connect', () => {
                console.log('Connected to server');
                elements.mainIndicator.classList.add('connected');
                elements.mainIndicator.classList.remove('disconnected');
                socket.emit('request_status');
                startFPSCounter();
            });
            
            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                elements.mainIndicator.classList.remove('connected');
                elements.mainIndicator.classList.add('disconnected');
                updateStatus('disconnected');
                stopFPSCounter();
            });
            
            socket.on('connection_status', updateConnectionStatus);
            socket.on('system_status', updateSystemStatus);
            socket.on('dual_predictions', updateDualPredictions);
            socket.on('system_update', updateSystemInfo);
            socket.on('drone_command_sent', (data) => {
                addCommandToHistory(data);
            });
            socket.on('manual_override_status', (data) => {
                manualOverride = data.active;
                updateManualOverrideDisplay();
            });
            socket.on('video_frame', handleVideoFrame);
        }
        
        function handleVideoFrame(data) {
            if (!data || !data.frame) return;
            
            // Update video display
            const imageUrl = 'data:image/jpeg;base64,' + data.frame;
            elements.videoDisplay.src = imageUrl;
            elements.videoDisplay.style.display = 'block';
            elements.noVideoMessage.style.display = 'none';
            
            // Update stats
            videoActive = true;
            lastVideoFrame = Date.now();
            videoFPSCounter++;
            
            if (data.frame_count) {
                elements.videoFrameCount.textContent = data.frame_count;
            }
            
            if (data.fps) {
                elements.videoFPSValue.textContent = data.fps.toFixed(1);
            }
            
            // Calculate latency
            if (data.timestamp) {
                const latency = Date.now() - data.timestamp;
                elements.videoLatency.textContent = latency + 'ms';
            }
            
            updateVideoStatus(true);
        }
        
        function updateVideoStatus(active) {
            if (active) {
                elements.videoStatusText.textContent = 'Video: Connected';
                elements.videoStreamStatus.textContent = 'Connected';
                elements.videoStreamStatus.classList.add('connected');
                elements.videoStreamStatus.classList.remove('disconnected');
                elements.debugVideoStream.textContent = 'Active';
                elements.debugVideoStream.style.color = '#00ff41';
            } else {
                elements.videoStatusText.textContent = 'Video: Disconnected';
                elements.videoStreamStatus.textContent = 'Disconnected';
                elements.videoStreamStatus.classList.remove('connected');
                elements.videoStreamStatus.classList.add('disconnected');
                elements.debugVideoStream.textContent = 'Inactive';
                elements.debugVideoStream.style.color = '#666';
                elements.videoDisplay.style.display = 'none';
                elements.noVideoMessage.style.display = 'block';
            }
        }
        
        function startFPSCounter() {
            videoFPSTimer = setInterval(() => {
                elements.videoCurrentFPS.textContent = videoFPSCounter;
                videoFPSCounter = 0;
                
                // Check if video is stale
                if (videoActive && (Date.now() - lastVideoFrame) > 2000) {
                    videoActive = false;
                    updateVideoStatus(false);
                }
            }, 1000);
        }
        
        function stopFPSCounter() {
            if (videoFPSTimer) {
                clearInterval(videoFPSTimer);
                videoFPSTimer = null;
            }
        }
        
        function saveSnapshot() {
            if (!elements.videoDisplay.src) {
                alert('No video to capture');
                return;
            }
            
            // Create a link to download the image
            const link = document.createElement('a');
            link.download = 'drone_snapshot_' + new Date().toISOString() + '.jpg';
            link.href = elements.videoDisplay.src;
            link.click();
        }
        
        function updateConnectionStatus(data) {
            updateStatusElement(elements.neurosityStatus, data.neurosity ? 'Connected' : 'Disconnected', data.neurosity);
            
            if (data.models_loaded && data.model_info) {
                const loadedCount = Object.values(data.model_info).filter(m => m.loaded).length;
                updateStatusElement(elements.modelStatus, `${loadedCount} Models`, loadedCount > 0);
            }
            
            if (data.mapper_state) {
                droneState = data.mapper_state.drone_state;
                updateDroneState();
            }
        }
        
        function updateSystemStatus(data) {
            updateStatusElement(elements.neurosityStatus, 
                data.neurosity_connected ? 'Connected' : 'Disconnected', 
                data.neurosity_connected);
            
            if (data.model_info) {
                const loadedCount = Object.values(data.model_info).filter(m => m.loaded).length;
                updateStatusElement(elements.modelStatus, `${loadedCount} Models`, loadedCount > 0);
            }
            
            if (data.mapper_state) {
                droneState = data.mapper_state.drone_state;
                updateDroneState();
                
                // Update heading control info
                if (data.mapper_state.heading_control) {
                    const hc = data.mapper_state.heading_control;
                    elements.headingControlValue.textContent = hc.smoothed_value.toFixed(3);
                    elements.headingDeadZone.textContent = hc.in_dead_zone ? 'YES' : 'NO';
                    elements.headingDeadZone.style.color = hc.in_dead_zone ? '#666' : '#00ff41';
                    
                    elements.debugHeadingControl.textContent = hc.enabled ? 'Active' : 'Disabled';
                    elements.debugHeadingControl.style.color = hc.enabled ? '#00ff41' : '#666';
                }
            }
            
            // Update video stats if available
            if (data.video_stats) {
                if (data.video_stats.frames_received > 0) {
                    elements.debugVideoStream.textContent = 'Receiving';
                    elements.debugVideoStream.style.color = '#00ff41';
                }
            }
            
            // Update manual override status
            if (data.manual_override !== undefined) {
                manualOverride = data.manual_override;
                updateManualOverrideDisplay();
            }
        }
        
        function updateDualPredictions(data) {
            if (data['4_class']) {
                update4ClassPredictions(data['4_class']);
            }
            if (data['8_class']) {
                update8ClassPredictions(data['8_class']);
            }
        }
        
        function update4ClassPredictions(prediction) {
            const probs = prediction.probabilities || {};
            
            elements['4class_restProb'].textContent = (probs.Rest || 0).toFixed(2);
            elements['4class_leftProb'].textContent = (probs.Left_Fist || 0).toFixed(2);
            elements['4class_rightProb'].textContent = (probs.Right_Fist || 0).toFixed(2);
            elements['4class_bothProb'].textContent = (probs.Both_Fists || 0).toFixed(2);
            
            updatePredictionBar('4class_restBar', probs.Rest, prediction.predicted_class === 'Rest', probs.Rest >= thresholds.Rest);
            updatePredictionBar('4class_leftBar', probs.Left_Fist, prediction.predicted_class === 'Left_Fist', probs.Left_Fist >= thresholds.Left_Fist);
            updatePredictionBar('4class_rightBar', probs.Right_Fist, prediction.predicted_class === 'Right_Fist', probs.Right_Fist >= thresholds.Right_Fist);
            updatePredictionBar('4class_bothBar', probs.Both_Fists, prediction.predicted_class === 'Both_Fists', probs.Both_Fists >= thresholds.Both_Fists);
        }
        
        function update8ClassPredictions(prediction) {
            const probs = prediction.probabilities || {};
            elements['8class_pushProb'].textContent = (probs.Push || 0).toFixed(2);
            updatePredictionBar('8class_pushBar', probs.Push || 0, prediction.predicted_class === 'Push', probs.Push >= thresholds.Push);
        }
        
        function updatePredictionBar(barId, probability, isActive, meetsThreshold) {
            const bar = elements[barId];
            if (!bar) return;
            
            probability = probability || 0;
            bar.style.width = `${probability * 100}%`;
            bar.classList.toggle('active', isActive && meetsThreshold);
            bar.classList.toggle('below-threshold', probability > 0.05 && !meetsThreshold);
        }
        
        function updateSystemInfo(data) {
            if (data.mapper_state) {
                droneState = data.mapper_state.drone_state;
                updateDroneState();
                
                if (data.mapper_state.heading_control) {
                    const hc = data.mapper_state.heading_control;
                    elements.headingControlValue.textContent = hc.smoothed_value.toFixed(3);
                    elements.headingDeadZone.textContent = hc.in_dead_zone ? 'YES' : 'NO';
                    elements.headingDeadZone.style.color = hc.in_dead_zone ? '#666' : '#00ff41';
                }
            }
            
            // Handle command completion
            if (data.command_completion) {
                const comp = data.command_completion;
                elements.debugLastStateChange.textContent = `${comp.command} completed (${comp.success ? 'success' : 'failed'})`;
                elements.debugLastStateChange.style.color = comp.success ? '#00ff41' : '#ff4141';
            }
        }
        
        function updateDroneState() {
            elements.droneState.textContent = droneState.charAt(0).toUpperCase() + droneState.slice(1);
            elements.droneState.className = 'status-value';
            
            // Update debug display
            elements.debugDroneState.textContent = droneState;
            elements.debugDroneState.style.color = droneState === 'flying' ? '#00ff41' : '#ffaa00';
            
            // Update state diagram
            const states = ['Grounded', 'TakingOff', 'Flying', 'Landing'];
            states.forEach(state => {
                const element = elements[`state${state}`];
                if (element) {
                    const isActive = droneState.toLowerCase().replace('_', '') === state.toLowerCase();
                    element.classList.toggle('active', isActive);
                }
            });
            
            if (droneState === 'flying') {
                elements.droneState.classList.add('connected');
            } else if (droneState === 'grounded') {
                elements.droneState.classList.add('warning');
            } else {
                elements.droneState.classList.add('warning');
            }
            
            elements.takeoffBtn.disabled = droneState !== 'grounded';
            elements.landBtn.disabled = droneState !== 'flying';
        }
        
        function updateStatusElement(element, text, isConnected) {
            element.textContent = text;
            element.classList.toggle('connected', isConnected);
            element.classList.toggle('disconnected', !isConnected);
        }
        
        function addCommandToHistory(data) {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'history-entry';
            
            let commandDisplay = data.command.toUpperCase();
            if (data.degrees) {
                commandDisplay += ` ${data.degrees}¬∞`;
            }
            
            entry.innerHTML = `
                <span>
                    <span class="history-time">${time}</span>
                    <span class="history-command">${commandDisplay}</span>
                    <span class="history-source">(${data.source_model}/${data.source_class})</span>
                </span>
                <span>${data.confidence ? data.confidence.toFixed(2) : ''}</span>
            `;
            
            if (elements.commandHistory.firstChild.textContent.includes('Waiting')) {
                elements.commandHistory.innerHTML = '';
            }
            elements.commandHistory.insertBefore(entry, elements.commandHistory.firstChild);
            
            while (elements.commandHistory.children.length > 20) {
                elements.commandHistory.removeChild(elements.commandHistory.lastChild);
            }
        }
        
        async function sendManualCommand(command) {
            try {
                const response = await fetch('/send_command', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ command })
                });
                const result = await response.json();
                if (!result.success) console.error('Failed to send command:', result.error);
            } catch (error) {
                console.error('Error sending command:', error);
            }
        }
        
        async function simulateCompletion(command) {
            try {
                const response = await fetch('/update_drone_state', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ command, success: true })
                });
                const result = await response.json();
                console.log('Simulated completion:', result);
            } catch (error) {
                console.error('Error simulating completion:', error);
            }
        }
        
        async function toggleManualOverride() {
            try {
                const response = await fetch('/toggle_manual_override', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });
                const result = await response.json();
                if (result.success) {
                    manualOverride = result.manual_override;
                    updateManualOverrideDisplay();
                }
            } catch (error) {
                console.error('Error toggling manual override:', error);
            }
        }
        
        function updateManualOverrideDisplay() {
            elements.overrideToggle.classList.toggle('active', manualOverride);
            elements.overrideStatus.textContent = manualOverride ? 'ON' : 'OFF';
            elements.overrideStatus.style.color = manualOverride ? '#ff6b00' : '#666';
            elements.debugManualOverride.textContent = manualOverride ? 'ON' : 'OFF';
            elements.debugManualOverride.style.color = manualOverride ? '#ff6b00' : '#666';
        }
        
        function resetHeadingController() {
            // This would need to be implemented on the backend
            console.log('Reset heading controller requested');
        }
        
        function updateStatus(status) {
            if (status === 'disconnected') {
                updateStatusElement(elements.neurosityStatus, 'Disconnected', false);
                updateStatusElement(elements.modelStatus, 'Not Loaded', false);
                updateVideoStatus(false);
            }
        }
        
        connectWebSocket();
        
        setInterval(() => {
            if (socket && socket.connected) {
                socket.emit('request_status');
            }
        }, 5000);
    </script>
</body>
</html>
