<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dual Model BCI Drone Control</title>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <style>
        /* General Reset */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        /* Body Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a; /* Dark background */
            color: #ffffff; /* White text */
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header Styling */
        header {
            background: #1a1a1a;
            padding: 1rem 2rem;
            border-bottom: 2px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-size: 1.8rem;
            font-weight: 300;
            letter-spacing: 0.05em;
        }
        
        .header-info {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
            color: #888;
        }
        
        /* Main Container */
        .container {
            flex: 1;
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Grid Layouts */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        /* Panel Styling (for main sections) */
        .panel {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .panel h2 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #00ff41; /* Green accent */
            font-weight: 400;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .model-indicator {
            font-size: 0.8rem;
            padding: 0.2rem 0.6rem;
            background: #333;
            border-radius: 4px;
            color: #aaa;
        }
        
        /* Model Specific Border Colors */
        .model-4class { border-left: 3px solid #00a8ff; } /* Blue for 4-class */
        .model-8class { border-left: 3px solid #ff6b00; } /* Orange for 8-class */
        
        /* Prediction Bars */
        .predictions {
            margin-top: 1rem;
        }
        
        .prediction-bar {
            margin-bottom: 1rem;
        }
        
        .prediction-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }
        
        .prediction-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .threshold-indicator {
            font-size: 0.7rem;
            color: #666;
        }
        
        .prediction-track {
            height: 24px;
            background: #0f0f0f;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 1px solid #2a2a2a;
        }
        
        .prediction-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff41, #00cc33); /* Green gradient */
            transition: width 0.3s ease;
            position: relative;
        }
        
        .prediction-fill.active {
            background: linear-gradient(90deg, #ff6b00, #ff4500); /* Orange gradient for active */
            box-shadow: 0 0 10px rgba(255, 107, 0, 0.5);
        }
        
        .prediction-fill.below-threshold {
            background: linear-gradient(90deg, #444, #666); /* Grey if below threshold */
        }
        
        .threshold-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ff0; /* Yellow line */
            opacity: 0.5;
            pointer-events: none;
        }
        
        /* Sustained Command Indicator */
        .sustained-indicator {
            background: #0f0f0f;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            margin-top: 1rem;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .sustained-indicator.active {
            border-color: #ff6b00;
            background: rgba(255, 107, 0, 0.1);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
        
        .sustained-command {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }
        
        .sustained-progress {
            height: 6px;
            background: #1a1a1a;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .sustained-fill {
            height: 100%;
            background: #ff6b00;
            width: 0%;
            transition: width 0.1s linear;
        }
        
        /* Status Grid */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        .status-item {
            background: #0f0f0f;
            padding: 0.8rem;
            border-radius: 4px;
            border: 1px solid #2a2a2a;
        }
        
        .status-label {
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-value {
            font-size: 1.1rem;
            margin-top: 0.2rem;
            font-weight: 500;
        }
        
        .status-value.connected { color: #00ff41; }
        .status-value.disconnected { color: #ff4141; }
        .status-value.warning { color: #ffaa00; }
        
        /* Command Flow Visualizer */
        .command-flow {
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 1rem;
            background: #0f0f0f;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .flow-item {
            text-align: center;
            padding: 0.5rem;
        }
        
        .flow-arrow {
            color: #666;
            font-size: 1.5rem;
        }
        
        .active-command {
            padding: 0.5rem 1rem;
            background: #ff6b00;
            color: #000;
            border-radius: 4px;
            font-weight: 600;
        }
        
        /* Drone Controls (Manual Buttons) */
        .drone-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .btn {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #fff;
            padding: 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .btn:hover:not(:disabled) {
            background: #3a3a3a;
            border-color: #666;
        }
        
        .btn:active:not(:disabled) {
            transform: scale(0.98);
        }
        
        .btn.primary {
            background: #00ff41;
            color: #000;
            border-color: #00ff41;
            font-weight: 600;
        }
        
        .btn.danger {
            background: #ff4141;
            border-color: #ff4141;
            font-weight: 600;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Command History */
        .command-history {
            max-height: 250px;
            overflow-y: auto;
            background: #0f0f0f;
            border-radius: 4px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            border: 1px solid #2a2a2a;
        }
        
        .history-entry {
            padding: 0.3rem 0;
            border-bottom: 1px solid #1a1a1a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-entry:last-child {
            border-bottom: none;
        }
        
        .history-time {
            color: #666;
            font-size: 0.8rem;
        }
        
        .history-command {
            color: #00ff41;
            font-weight: 600;
        }
        
        .history-source {
            color: #888;
            font-size: 0.8rem;
        }
        
        /* Connection Indicator Dot */
        .connection-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        
        .connection-indicator.connected {
            background: #00ff41;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }
        
        .connection-indicator.disconnected {
            background: #ff4141;
        }
        
        /* Bottom Grid Layout */
        .bottom-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }
        
        /* Responsive Adjustments */
        @media (max-width: 1200px) {
            .main-grid, .bottom-grid {
                grid-template-columns: 1fr;
            }
            
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .drone-controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>
            Dual Model BCI Drone Control
            <span id="mainConnectionIndicator" class="connection-indicator disconnected"></span>
        </h1>
        <div class="header-info">
            <span>4-Class: Rotation/Fwd</span>
            <span>|</span>
            <span>8-Class: Actions</span>
            <span>|</span>
            <button id="modeToggle" class="mode-toggle" onclick="toggleControlMode()">
                Mode: <span id="currentMode">Discrete</span>
            </button>
        </div>
    </header>
    
    <div class="container">
        <!-- Main prediction panels -->
        <div class="main-grid">
            <!-- 4-Class Model Panel -->
            <div class="panel model-4class">
                <h2>
                    4-Class Control Model
                    <span class="model-indicator">4-Class</span>
                </h2>
                <div class="predictions">
                    <div class="prediction-bar">
                        <div class="prediction-label">
                            <span>Rest</span>
                            <div class="prediction-info">
                                <span id="4class_restProb">0.00</span>
                                <span class="threshold-indicator">(≥0.50)</span>
                            </div>
                        </div>
                        <div class="prediction-track">
                            <div id="4class_restBar" class="prediction-fill" style="width: 0%"></div>
                            <div class="threshold-line" style="left: 50%"></div>
                        </div>
                    </div>
                    <div class="prediction-bar">
                        <div class="prediction-label">
                            <span>Left Fist → Rotate Left</span>
                            <div class="prediction-info">
                                <span id="4class_leftProb">0.00</span>
                                <span class="threshold-indicator">(≥0.70)</span>
                            </div>
                        </div>
                        <div class="prediction-track">
                            <div id="4class_leftBar" class="prediction-fill" style="width: 0%"></div>
                            <div class="threshold-line" style="left: 70%"></div>
                        </div>
                    </div>
                    <div class="prediction-bar">
                        <div class="prediction-label">
                            <span>Right Fist → Rotate Right</span>
                            <div class="prediction-info">
                                <span id="4class_rightProb">0.00</span>
                                <span class="threshold-indicator">(≥0.70)</span>
                            </div>
                        </div>
                        <div class="prediction-track">
                            <div id="4class_rightBar" class="prediction-fill" style="width: 0%"></div>
                            <div class="threshold-line" style="left: 70%"></div>
                        </div>
                    </div>
                    <div class="prediction-bar">
                        <div class="prediction-label">
                            <span>Both Fists → Continuous Control</span>
                            <div class="prediction-info">
                                <span id="4class_bothProb">0.00</span>
                                <span class="threshold-indicator">(≥0.65)</span>
                            </div>
                        </div>
                        <div class="prediction-track">
                            <div id="4class_bothBar" class="prediction-fill" style="width: 0%"></div>
                            <div class="threshold-line" style="left: 65%"></div>
                        </div>
                    </div>
                </div>
                
                <div id="4class_sustainedIndicator" class="sustained-indicator">
                    <div id="4class_sustainedCommand" class="sustained-command">No Command</div>
                    <div style="font-size: 0.8rem; color: #888;">Hold for 1.5s</div>
                    <div class="sustained-progress">
                        <div id="4class_sustainedFill" class="sustained-fill"></div>
                    </div>
                </div>
            </div>
            
            <!-- 8-Class Model Panel -->
            <div class="panel model-8class">
                <h2>
                    Action Control Model
                    <span class="model-indicator">8-Class</span>
                </h2>
                <div class="predictions">
                    <div class="prediction-bar">
                        <div class="prediction-label">
                            <span>Push → Takeoff/Land</span>
                            <div class="prediction-info">
                                <span id="8class_pushProb">0.00</span>
                                <span class="threshold-indicator">(≥0.75)</span>
                            </div>
                        </div>
                        <div class="prediction-track">
                            <div id="8class_pushBar" class="prediction-fill" style="width: 0%"></div>
                            <div class="threshold-line" style="left: 75%"></div>
                        </div>
                    </div>
                </div>
                
                <div id="8class_sustainedIndicator" class="sustained-indicator">
                    <div id="8class_sustainedCommand" class="sustained-command">No Command</div>
                    <div style="font-size: 0.8rem; color: #888;">Hold for 2.0s</div>
                    <div class="sustained-progress">
                        <div id="8class_sustainedFill" class="sustained-fill"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Status and Controls -->
        <div class="bottom-grid">
            <div class="panel">
                <h2>System Status</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">Neurosity</div>
                        <div id="neurosityStatus" class="status-value disconnected">Disconnected</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Models</div>
                        <div id="modelStatus" class="status-value disconnected">Not Loaded</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Drone State</div>
                        <div id="droneState" class="status-value">Grounded</div>
                    </div>
                </div>
                
                <div class="command-flow">
                    <div class="flow-item">
                        <div id="activeModel" style="color: #888;">No Active Model</div>
                    </div>
                    <div class="flow-arrow">→</div>
                    <div class="flow-item">
                        <div id="activeCommand" class="active-command" style="display: none;">-</div>
                        <div id="noCommand" style="color: #666;">No Command</div>
                    </div>
                    <div class="flow-arrow">→</div>
                    <div class="flow-item">
                        <div id="droneAction" style="color: #888;">Waiting</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; font-size: 1.1rem; color: #00ff41;">
                    Manual Controls
                </h3>
                <div class="drone-controls">
                    <button id="takeoffBtn" class="btn primary" onclick="sendManualCommand('takeoff')">
                        Takeoff
                    </button>
                    <button id="landBtn" class="btn danger" onclick="sendManualCommand('land')">
                        Land
                    </button>
                    <button class="btn danger" onclick="sendManualCommand('emergency')">
                        Emergency
                    </button>
                    <button class="btn" onclick="sendManualCommand('rotate_left')">
                        ← Left
                    </button>
                    <button class="btn" onclick="sendManualCommand('status')">
                        Status
                    </button>
                    <button class="btn" onclick="sendManualCommand('rotate_right')">
                        Right →
                    </button>
                </div>
            </div>
            
            <div class="panel">
                <h2>Command History</h2>
                <div id="commandHistory" class="command-history">
                    <div class="history-entry">
                        <span>Waiting for commands...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // WebSocket connection
        let socket = null;
        let droneState = 'grounded';
        
        // DOM elements
        const elements = {
            mainIndicator: document.getElementById('mainConnectionIndicator'),
            neurosityStatus: document.getElementById('neurosityStatus'),
            modelStatus: document.getElementById('modelStatus'),
            droneState: document.getElementById('droneState'),
            activeModel: document.getElementById('activeModel'),
            activeCommand: document.getElementById('activeCommand'),
            noCommand: document.getElementById('noCommand'),
            droneAction: document.getElementById('droneAction'),
            commandHistory: document.getElementById('commandHistory'),
            takeoffBtn: document.getElementById('takeoffBtn'),
            landBtn: document.getElementById('landBtn'),
            
            // 4-class elements
            '4class_restProb': document.getElementById('4class_restProb'),
            '4class_leftProb': document.getElementById('4class_leftProb'),
            '4class_rightProb': document.getElementById('4class_rightProb'),
            '4class_bothProb': document.getElementById('4class_bothProb'),
            '4class_restBar': document.getElementById('4class_restBar'),
            '4class_leftBar': document.getElementById('4class_leftBar'),
            '4class_rightBar': document.getElementById('4class_rightBar'),
            '4class_bothBar': document.getElementById('4class_bothBar'),
            '4class_sustainedIndicator': document.getElementById('4class_sustainedIndicator'),
            '4class_sustainedCommand': document.getElementById('4class_sustainedCommand'),
            '4class_sustainedFill': document.getElementById('4class_sustainedFill'),
            
            // 8-class elements
            '8class_pushProb': document.getElementById('8class_pushProb'),
            '8class_pushBar': document.getElementById('8class_pushBar'),
            '8class_sustainedIndicator': document.getElementById('8class_sustainedIndicator'),
            '8class_sustainedCommand': document.getElementById('8class_sustainedCommand'),
            '8class_sustainedFill': document.getElementById('8class_sustainedFill')
        };
        
        // Confidence thresholds (from config.py, mirrored here for frontend display logic)
        const thresholds = {
            'Rest': 0.50,
            'Left_Fist': 0.70,
            'Right_Fist': 0.70,
            'Both_Fists': 0.65,
            'Push': 0.75,
        };
        
        // Connect to WebSocket
        function connectWebSocket() {
            socket = io(window.location.origin);
            
            socket.on('connect', () => {
                console.log('Connected to server');
                elements.mainIndicator.classList.add('connected');
                elements.mainIndicator.classList.remove('disconnected');
                socket.emit('request_status');
            });
            
            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                elements.mainIndicator.classList.remove('connected');
                elements.mainIndicator.classList.add('disconnected');
                updateStatus('disconnected');
            });
            
            socket.on('connection_status', updateConnectionStatus);
            socket.on('system_status', updateSystemStatus);
            socket.on('dual_predictions', updateDualPredictions);
            socket.on('system_update', updateSystemInfo);
            socket.on('drone_command_sent', (data) => {
                addCommandToHistory(data);
                updateDroneAction(data.command);
            });
        }
        
        function updateConnectionStatus(data) {
            updateStatusElement(elements.neurosityStatus, data.neurosity ? 'Connected' : 'Disconnected', data.neurosity);
            
            if (data.models_loaded && data.model_info) {
                const loadedCount = Object.values(data.model_info).filter(m => m.loaded).length;
                updateStatusElement(elements.modelStatus, `${loadedCount} Models`, loadedCount > 0);
            }
            
            if (data.mapper_state) {
                droneState = data.mapper_state.drone_state;
                updateDroneState();
            }
        }
        
        function updateSystemStatus(data) {
            updateStatusElement(elements.neurosityStatus, 
                data.neurosity_connected ? 'Connected' : 'Disconnected', 
                data.neurosity_connected);
            
            if (data.model_info) {
                const loadedCount = Object.values(data.model_info).filter(m => m.loaded).length;
                updateStatusElement(elements.modelStatus, `${loadedCount} Models`, loadedCount > 0);
            }
            
            if (data.mapper_state) {
                droneState = data.mapper_state.drone_state;
                updateDroneState();
            }
        }
        
        function updateDualPredictions(data) {
            if (data['4_class']) 
                update4ClassPredictions(data['4_class']);
            }
            if (data['8_class']) {
                update8ClassPredictions(data['8_class']);
            }
        }
        
        function update4ClassPredictions(prediction) {
            const probs = prediction.probabilities || {};
            
            elements['4class_restProb'].textContent = (probs.Rest || 0).toFixed(2);
            elements['4class_leftProb'].textContent = (probs.Left_Fist || 0).toFixed(2);
            elements['4class_rightProb'].textContent = (probs.Right_Fist || 0).toFixed(2);
            elements['4class_bothProb'].textContent = (probs.Both_Fists || 0).toFixed(2);
            
            updatePredictionBar('4class_restBar', probs.Rest, prediction.predicted_class === 'Rest', probs.Rest >= thresholds.Rest);
            updatePredictionBar('4class_leftBar', probs.Left_Fist, prediction.predicted_class === 'Left_Fist', probs.Left_Fist >= thresholds.Left_Fist);
            updatePredictionBar('4class_rightBar', probs.Right_Fist, prediction.predicted_class === 'Right_Fist', probs.Right_Fist >= thresholds.Right_Fist);
            updatePredictionBar('4class_bothBar', probs.Both_Fists, prediction.predicted_class === 'Both_Fists', probs.Both_Fists >= thresholds.Both_Fists);
        }
        
        function update8ClassPredictions(prediction) {
            const probs = prediction.probabilities || {};
            elements['8class_pushProb'].textContent = (probs.Push || 0).toFixed(2);
            updatePredictionBar('8class_pushBar', probs.Push || 0, prediction.predicted_class === 'Push', probs.Push >= thresholds.Push);
        }
        
        function updatePredictionBar(barId, probability, isActive, meetsThreshold) {
            const bar = elements[barId];
            if (!bar) return;
            
            probability = probability || 0;
            bar.style.width = `${probability * 100}%`;
            bar.classList.toggle('active', isActive && meetsThreshold);
            bar.classList.toggle('below-threshold', probability > 0.05 && !meetsThreshold);
        }
        
        function updateSystemInfo(data) {
            if (data.sustained_info) {
                updateSustainedDisplays(data.sustained_info);
            }
            
            if (data.mapper_state) {
                droneState = data.mapper_state.drone_state;
                updateDroneState();
                
                if (data.mapper_state.last_command) {
                    showActiveCommand(data.mapper_state.last_command);
                }
            }
        }
        
        function updateSustainedDisplays(sustainedInfo) {
            // Update the 4-class sustained indicator
            updateModelSustained('4class', ['Left_Fist', 'Right_Fist'], sustainedInfo);
            
            // Update the 8-class sustained indicator
            updateModelSustained('8class', ['Push'], sustainedInfo);
        }
        
        function updateModelSustained(modelPrefix, classes, sustainedInfo) {
            let activeSustained = null;
            let maxProgress = 0;
            
            for (const className of classes) {
                if (sustainedInfo[className]) {
                    const info = sustainedInfo[className];
                    if (info.progress > maxProgress) {
                        maxProgress = info.progress;
                        activeSustained = { class: className, ...info };
                    }
                }
            }
            
            const indicator = elements[`${modelPrefix}_sustainedIndicator`];
            const command = elements[`${modelPrefix}_sustainedCommand`];
            const fill = elements[`${modelPrefix}_sustainedFill`];
            
            if (activeSustained && !activeSustained.triggered) {
                indicator.classList.add('active');
                command.textContent = getCommandDisplay(activeSustained.class);
                fill.style.width = `${activeSustained.progress * 100}%`;
                
                elements.activeModel.textContent = modelPrefix === '4class' ? '4-Class Model' : 'Action Model';
                elements.activeModel.style.color = '#ff6b00';
            } else {
                indicator.classList.remove('active');
                command.textContent = 'No Command';
                fill.style.width = '0%';
            }
        }
        
        function getCommandDisplay(className) {
            const mappings = {
                'Left_Fist': 'ROTATE LEFT',
                'Right_Fist': 'ROTATE RIGHT',
                'Push': droneState === 'grounded' ? 'TAKEOFF' : 'LAND'
            };
            return mappings[className] || className;
        }
        
        function showActiveCommand(command) {
            elements.activeCommand.textContent = command.toUpperCase();
            elements.activeCommand.style.display = 'block';
            elements.noCommand.style.display = 'none';
            
            setTimeout(() => {
                elements.activeCommand.style.display = 'none';
                elements.noCommand.style.display = 'block';
                elements.activeModel.style.color = '#888';
            }, 2000);
        }
        
        function updateDroneState() {
            elements.droneState.textContent = droneState.charAt(0).toUpperCase() + droneState.slice(1);
            elements.droneState.className = 'status-value';
            
            if (droneState === 'flying') {
                elements.droneState.classList.add('connected');
            } else if (droneState === 'grounded') {
                elements.droneState.classList.add('warning');
            } else {
                elements.droneState.classList.add('warning');
            }
            
            elements.takeoffBtn.disabled = droneState !== 'grounded';
            elements.landBtn.disabled = droneState !== 'flying';
        }
        
        function updateDroneAction(command) {
            const actionMap = {
                'takeoff': 'Taking Off', 'land': 'Landing',
                'rotate_left': 'Rotating Left', 'rotate_right': 'Rotating Right',
                'forward': 'Moving Forward', 'back': 'Moving Back',
                'left': 'Strafing Left', 'right': 'Strafing Right',
                'up': 'Ascending', 'down': 'Descending',
                'emergency': 'EMERGENCY STOP'
            };
            
            elements.droneAction.textContent = actionMap[command] || command;
            elements.droneAction.style.color = '#ff6b00';
            
            setTimeout(() => {
                elements.droneAction.textContent = 'Waiting';
                elements.droneAction.style.color = '#888';
            }, 3000);
        }
        
        function updateStatusElement(element, text, isConnected) {
            element.textContent = text;
            element.classList.toggle('connected', isConnected);
            element.classList.toggle('disconnected', !isConnected);
        }
        
        function addCommandToHistory(data) {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'history-entry';
            entry.innerHTML = `
                <span>
                    <span class="history-time">${time}</span>
                    <span class="history-command">${data.command.toUpperCase()}</span>
                    <span class="history-source">(${data.source_model}/${data.source_class})</span>
                </span>
                <span>${data.confidence.toFixed(2)}</span>
            `;
            
            if (elements.commandHistory.firstChild.textContent.includes('Waiting')) {
                elements.commandHistory.innerHTML = '';
            }
            elements.commandHistory.insertBefore(entry, elements.commandHistory.firstChild);
            
            while (elements.commandHistory.children.length > 20) {
                elements.commandHistory.removeChild(elements.commandHistory.lastChild);
            }
        }
        
        async function sendManualCommand(command) {
            try {
                const response = await fetch('/send_command', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ command })
                });
                const result = await response.json();
                if (!result.success) console.error('Failed to send command:', result.error);
            } catch (error) {
                console.error('Error sending command:', error);
            }
        }
        
        function updateStatus(status) {
            if (status === 'disconnected') {
                updateStatusElement(elements.neurosityStatus, 'Disconnected', false);
                updateStatusElement(elements.modelStatus, 'Not Loaded', false);
            }
        }
        
        connectWebSocket();
        
        setInterval(() => {
            if (socket && socket.connected) {
                socket.emit('request_status');
            }
        }, 5000);
    </script>
</body>
</html>
